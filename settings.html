<!-- @format -->

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Twitch Fighter | Auth</title>

		<link rel="stylesheet" href="assets/fonts/fonts.css" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<script
			src="https://code.jquery.com/jquery-3.5.1.min.js"
			integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			crossorigin="anonymous"
		></script>
		<script src="//unpkg.com/twitch-js@>2.0.0-beta.31"></script>
		<script src="assets/js/purify.min.js"></script>

		<script src="assets/js/twitchinfo.js"></script>
	</head>
	<body>
		<h1>Access Info:</h1>
		<h2>Token: <span id="token"></span></h2>
		<h2>Scope: <span id="scope"></span></h2>
		<h2>Token Type: <span id="token-type"></span></h2>
		<hr />
		<h3>User Id: <span id="user-id"></span></h3>
		<h3>Username: <span id="username"></span></h3>
		<img id="profile-img" />

		<pre id="chat"></pre>

		<script>
			let authResponse = parseTwitchResponse(document.location.hash);

			console.log(authResponse);

			$("#token").text(authResponse.access_token);
			$("#scope").text(authResponse.scope);
			$("#token-type").text(authResponse.token_type);

			getTwitchData(authResponse);

			function parseTwitchResponse(queryString) {
				var query = {};
				var pairs = (queryString[0] === "#" ? queryString.substr(1) : queryString).split("&");
				for (var i = 0; i < pairs.length; i++) {
					var pair = pairs[i].split("=");
					query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || "");
				}
				return query;
			}

			function getTwitchData(authResponse) {
				let xhr = new XMLHttpRequest();
				xhr.open("GET", "https://api.twitch.tv/helix/users");
				xhr.setRequestHeader("Authorization", "Bearer " + authResponse.access_token);
				xhr.setRequestHeader("Client-ID", TwitchInfo.clientId);

				xhr.send();

				xhr.onload = function () {
					processResponse(xhr.response);
				};

				xhr.onerror = function () {
					// only triggers if the request couldn't be made at all
					alert(`Network Error ${xhr.status} ${xhr.response}`);
				};
			}

			function processResponse(response) {
				response = JSON.parse(response);

				console.log(response);

				$("#user-id").text(response.data[0].id);
				$("#username").text(response.data[0].display_name);
				$("#profile-img").attr("src", response.data[0].profile_image_url);

				authTwitch(response);
			}

			function authTwitch(response) {
				// Provide your token, username and channel. You can generate a token
				// here: https://twitchapps.com/tmi/
				const clientId = TwitchInfo.clientId;
				const username = response.data[0].login;

				const channel = username;

				// Instantiate clients.
				const { chat } = new TwitchJs({ clientId });

				const handleMessage = (message) => {
					if (message.event == "PRIVMSG") {
						console.log(message);

						let prevChat = $("#chat").html();

						var clean = strip(message.message);

						$("#chat").html(prevChat + "<br><b>" + message.username + ":</b> " + clean);
					}
				};

				// Listen for all events.
				chat.on(TwitchJs.Chat.Events.ALL, handleMessage);

				// Connect ...
				chat.connect().then(() => {
					// ... and then join the channel.
					chat.join(channel);
				});
			}

			function strip(html) {
				var doc = new DOMParser().parseFromString(html, "text/html");
				return doc.body.textContent || "";
			}
		</script>
	</body>
</html>
